<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Unit Tests</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        h1 { color: #1a1a1a; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .summary { font-size: 1.2em; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Security Modules Unit Tests</h1>
    
    <div id="results"></div>
    <div id="summary" class="summary"></div>

    <!-- Load Modules -->
    <script src="../../js/core/inputValidator.js"></script>
    <script src="../../js/core/htmlSanitizer.js"></script>

    <script>
        const results = document.getElementById('results');
        let passed = 0;
        let failed = 0;

        function assert(condition, message) {
            const div = document.createElement('div');
            div.className = 'test-container';
            if (condition) {
                div.innerHTML = `<span class="pass">‚úì PASS</span>: ${message}`;
                passed++;
            } else {
                div.innerHTML = `<span class="fail">‚úó FAIL</span>: ${message}`;
                failed++;
                console.error('Test failed:', message);
            }
            results.appendChild(div);
        }

        function runTests() {
            // ==========================================
            // InputValidator Tests
            // ==========================================
            results.innerHTML += '<h2>InputValidator Tests</h2>';

            // Test 1: Empty input
            assert(InputValidator.validate('', 'text').valid === false, 'Should reject empty string');
            assert(InputValidator.validate('   ', 'text').valid === false, 'Should reject whitespace only');

            // Test 2: Valid text
            assert(InputValidator.validate('Hello World', 'text').valid === true, 'Should accept valid text');

            // Test 3: Length limits
            const longText = 'a'.repeat(1001);
            assert(InputValidator.validate(longText, 'text').valid === false, 'Should reject text exceeding max length');

            // Test 4: XSS Attempt
            const xssInput = '<script>alert(1)</script>';
            const validation = InputValidator.validate(xssInput, 'text');
            assert(validation.valid === true, 'Should accept input but mark as needing sanitization');
            // Note: InputValidator might sanitize internally or just validate structure depending on implementation. 
            // Let's check if it sanitizes or if we need to call sanitize separately.
            
            // ==========================================
            // HTMLSanitizer Tests
            // ==========================================
            results.innerHTML += '<h2>HTMLSanitizer Tests</h2>';

            // Test 5: Basic Sanitization
            const dirty = '<script>alert("xss")</script>Hello<b>World</b>';
            const clean = HTMLSanitizer.sanitize(dirty);
            assert(clean.includes('<script>') === false, 'Should remove script tags');
            assert(clean.includes('Hello') === true, 'Should preserve text content');
            
            // Test 6: Attribute Sanitization
            const dirtyAttr = '<a href="javascript:alert(1)" onclick="steal()">Link</a>';
            const cleanAttr = HTMLSanitizer.sanitize(dirtyAttr);
            assert(cleanAttr.includes('javascript:') === false, 'Should remove javascript: href');
            assert(cleanAttr.includes('onclick') === false, 'Should remove event handlers');

            // Test 7: Allowed Tags
            const allowed = '<b>Bold</b><i>Italic</i><p>Para</p>';
            const cleanAllowed = HTMLSanitizer.sanitize(allowed);
            assert(cleanAllowed === allowed, 'Should preserve allowed tags');

            // Test 8: Nested Malicious
            const nested = '<div><script>nested</script>Safe</div>';
            const cleanNested = HTMLSanitizer.sanitize(nested);
            assert(cleanNested.includes('script') === false, 'Should handle nested malicious tags');

            // Summary
            const summary = document.getElementById('summary');
            summary.innerHTML = `Total: ${passed + failed} | Passed: <span class="pass">${passed}</span> | Failed: <span class="fail">${failed}</span>`;
            
            if (failed === 0) {
                summary.style.color = 'green';
            } else {
                summary.style.color = 'red';
            }
        }

        // Run tests when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }
    </script>
</body>
</html>
