<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Completo - Whispers of the Wave</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/themes.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="stylesheet" href="../css/splash.css">
    <style>
        .test-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ffff;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
            font-family: monospace;
            font-size: 12px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #00ffff;
            border-radius: 5px;
        }
        .test-section h3 {
            margin: 0 0 10px 0;
            color: #00ffff;
        }
        .test-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #1a4d5c;
            color: #00ffff;
            border: 1px solid #00ffff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #00ffff;
            color: #0a1628;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .test-pass {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }
        .test-fail {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }
        .test-info {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
        }
        .flash-detector {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 10001;
        }
    </style>
</head>
<body>

    <!-- Flash Detector -->
    <div class="flash-detector" id="flashDetector">‚ö†Ô∏è Flash visual detectado!</div>

    <!-- Test Panel -->
    <div class="test-panel">
        <h2 style="margin-top: 0;">üß™ Test Completo</h2>
        
        <div class="test-section">
            <h3>üåê Internacionalizaci√≥n</h3>
            <button class="test-button" onclick="testI18n()">Test Cambio de Idiomas</button>
            <button class="test-button" onclick="testAllTranslations()">Verificar Traducciones</button>
            <div id="i18nResults"></div>
        </div>

        <div class="test-section">
            <h3>üé® Temas</h3>
            <button class="test-button" onclick="testThemeSwitch()">Test Cambio de Tema</button>
            <button class="test-button" onclick="testThemeFlash()">Detectar Flash Visual</button>
            <div id="themeResults"></div>
        </div>

        <div class="test-section">
            <h3>üåä Olas y Sugerencias</h3>
            <button class="test-button" onclick="testWaveSelection()">Test Selecci√≥n de Olas</button>
            <button class="test-button" onclick="testSuggestions()">Test Sugerencias</button>
            <div id="waveResults"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Funcionalidades</h3>
            <button class="test-button" onclick="testAchievements()">Test Logros</button>
            <button class="test-button" onclick="testOceanDynamics()">Test Din√°mica Oce√°nica</button>
            <button class="test-button" onclick="testOceanColors()">Test Colores del Oc√©ano</button>
            <button class="test-button" onclick="testModal()">Test Modal</button>
            <div id="featuresResults"></div>
        </div>

        <div class="test-section">
            <h3>üì± Responsive</h3>
            <button class="test-button" onclick="testResponsive()">Test Responsive</button>
            <div id="responsiveResults"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Test Completo</h3>
            <button class="test-button" onclick="runAllTests()" style="background: #ff6b6b; font-weight: bold;">‚ñ∂Ô∏è Ejecutar Todos</button>
            <div id="allResults"></div>
        </div>
    </div>

    <!-- Include all necessary scripts -->
    <script src="../js/i18n/translations.js"></script>
    <script src="../js/i18n/i18n-ui.js"></script>
    <script src="../js/ui/modal.js"></script>
    <script src="../js/ui/suggestions.js"></script>
    <script src="../js/engine/oceanDynamics.js"></script>
    <script src="../js/engine/achievementSystem.js"></script>

    <script>
        // Test Results Helper
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result test-${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Flash Detector
        let lastBodyColor = null;
        let flashDetectorInterval = null;

        function startFlashDetector() {
            const body = document.body;
            lastBodyColor = window.getComputedStyle(body).backgroundColor;
            
            flashDetectorInterval = setInterval(() => {
                const currentColor = window.getComputedStyle(body).backgroundColor;
                if (currentColor !== lastBodyColor) {
                    showFlashWarning();
                    lastBodyColor = currentColor;
                }
            }, 16); // Check every frame (~60fps)
        }

        function stopFlashDetector() {
            if (flashDetectorInterval) {
                clearInterval(flashDetectorInterval);
                flashDetectorInterval = null;
            }
        }

        function showFlashWarning() {
            const detector = document.getElementById('flashDetector');
            detector.style.display = 'block';
            setTimeout(() => {
                detector.style.display = 'none';
            }, 2000);
        }

        // I18N Tests
        async function testI18n() {
            clearResults('i18nResults');
            addResult('i18nResults', 'üîÑ Probando cambio de idiomas...', 'info');
            
            const languages = ['es', 'en', 'fr', 'de'];
            let passed = 0;
            let failed = 0;

            for (const lang of languages) {
                try {
                    if (window.i18n) {
                        window.i18n.setLanguage(lang);
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        const currentLang = window.i18n.currentLanguage;
                        if (currentLang === lang) {
                            addResult('i18nResults', `‚úì ${lang.toUpperCase()} OK`, 'pass');
                            passed++;
                        } else {
                            addResult('i18nResults', `‚úó ${lang.toUpperCase()} FAIL`, 'fail');
                            failed++;
                        }
                    }
                } catch (error) {
                    addResult('i18nResults', `‚úó ${lang.toUpperCase()} ERROR: ${error.message}`, 'fail');
                    failed++;
                }
            }

            addResult('i18nResults', `üìä Resultado: ${passed}/${languages.length} idiomas OK`, passed === languages.length ? 'pass' : 'fail');
        }

        async function testAllTranslations() {
            clearResults('i18nResults');
            addResult('i18nResults', 'üîç Verificando traducciones...', 'info');
            
            if (!window.translations) {
                addResult('i18nResults', '‚úó No se encontr√≥ el objeto translations', 'fail');
                return;
            }

            const languages = Object.keys(window.translations);
            const keys = Object.keys(window.translations.es || {});
            let missingCount = 0;

            for (const lang of languages) {
                const missing = [];
                for (const key of keys) {
                    if (!window.translations[lang][key]) {
                        missing.push(key);
                    }
                }
                
                if (missing.length === 0) {
                    addResult('i18nResults', `‚úì ${lang.toUpperCase()}: Todas las claves presentes`, 'pass');
                } else {
                    addResult('i18nResults', `‚úó ${lang.toUpperCase()}: Faltan ${missing.length} claves`, 'fail');
                    missingCount += missing.length;
                }
            }

            addResult('i18nResults', `üìä Total claves faltantes: ${missingCount}`, missingCount === 0 ? 'pass' : 'fail');
        }

        // Theme Tests
        async function testThemeSwitch() {
            clearResults('themeResults');
            addResult('themeResults', 'üé® Probando cambio de tema...', 'info');
            
            const body = document.body;
            const originalTheme = body.getAttribute('data-theme') || 'dark';
            
            // Test dark theme
            body.setAttribute('data-theme', 'dark');
            await new Promise(resolve => setTimeout(resolve, 100));
            const isDark = body.getAttribute('data-theme') === 'dark';
            addResult('themeResults', isDark ? '‚úì Tema oscuro OK' : '‚úó Tema oscuro FAIL', isDark ? 'pass' : 'fail');
            
            // Test light theme
            body.setAttribute('data-theme', 'light');
            await new Promise(resolve => setTimeout(resolve, 100));
            const isLight = body.getAttribute('data-theme') === 'light';
            addResult('themeResults', isLight ? '‚úì Tema claro OK' : '‚úó Tema claro FAIL', isLight ? 'pass' : 'fail');
            
            // Restore original
            body.setAttribute('data-theme', originalTheme);
            addResult('themeResults', 'üìä Test de temas completado', 'info');
        }

        async function testThemeFlash() {
            clearResults('themeResults');
            addResult('themeResults', 'üëÅÔ∏è Iniciando detector de flash...', 'info');
            addResult('themeResults', 'Cambiando tema r√°pidamente...', 'info');
            
            startFlashDetector();
            
            const body = document.body;
            for (let i = 0; i < 5; i++) {
                body.setAttribute('data-theme', 'light');
                await new Promise(resolve => setTimeout(resolve, 200));
                body.setAttribute('data-theme', 'dark');
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            stopFlashDetector();
            addResult('themeResults', '‚úì Test de flash completado', 'pass');
            addResult('themeResults', 'Si viste alertas rojas, hay flashes visuales', 'info');
        }

        // Wave Tests
        async function testWaveSelection() {
            clearResults('waveResults');
            addResult('waveResults', 'üåä Probando selecci√≥n de olas...', 'info');
            
            const waveTypes = ['gentle', 'deep', 'storm', 'philosophical'];
            let passed = 0;

            for (const type of waveTypes) {
                try {
                    // Simulate wave selection
                    const event = new CustomEvent('waveSelected', { detail: { type } });
                    document.dispatchEvent(event);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    addResult('waveResults', `‚úì Ola ${type} seleccionada`, 'pass');
                    passed++;
                } catch (error) {
                    addResult('waveResults', `‚úó Error en ola ${type}: ${error.message}`, 'fail');
                }
            }

            addResult('waveResults', `üìä ${passed}/${waveTypes.length} olas OK`, passed === waveTypes.length ? 'pass' : 'fail');
        }

        async function testSuggestions() {
            clearResults('waveResults');
            addResult('waveResults', 'üí° Probando sistema de sugerencias...', 'info');
            
            if (!window.SuggestionSystem) {
                addResult('waveResults', '‚úó SuggestionSystem no encontrado', 'fail');
                return;
            }

            try {
                // SuggestionSystem is a module, not a class
                const waveTypes = ['calm', 'deep', 'energetic', 'healing'];
                
                let passed = 0;
                for (const type of waveTypes) {
                    // Test that the module has methods
                    if (typeof window.SuggestionSystem.displayInitial === 'function') {
                        addResult('waveResults', `‚úì M√≥dulo de sugerencias tiene m√©todos`, 'pass');
                        passed++;
                        break; // Only test once
                    }
                }
                
                if (passed > 0) {
                    addResult('waveResults', `‚úì Sistema de sugerencias funcional`, 'pass');
                } else {
                    addResult('waveResults', `‚úó Sistema de sugerencias no funcional`, 'fail');
                }
            } catch (error) {
                addResult('waveResults', `‚úó Error: ${error.message}`, 'fail');
            }
        }

        // Features Tests
        async function testAchievements() {
            clearResults('featuresResults');
            addResult('featuresResults', 'üéØ Probando sistema de logros...', 'info');
            
            if (!window.AchievementSystem) {
                addResult('featuresResults', '‚úó AchievementSystem no encontrado', 'fail');
                return;
            }

            try {
                const achievementSystem = new window.AchievementSystem();
                const achievements = achievementSystem.getAllAchievements();
                
                if (achievements && achievements.length > 0) {
                    addResult('featuresResults', `‚úì ${achievements.length} logros cargados`, 'pass');
                    
                    // Test unlock
                    achievementSystem.checkAchievements({ messageCount: 1 });
                    addResult('featuresResults', '‚úì Sistema de desbloqueo funciona', 'pass');
                } else {
                    addResult('featuresResults', '‚úó No se encontraron logros', 'fail');
                }
            } catch (error) {
                addResult('featuresResults', `‚úó Error: ${error.message}`, 'fail');
            }
        }

        async function testOceanDynamics() {
            clearResults('featuresResults');
            addResult('featuresResults', 'üåä Probando din√°mica oce√°nica...', 'info');
            
            if (!window.OceanDynamics) {
                addResult('featuresResults', '‚úó OceanDynamics no encontrado', 'fail');
                return;
            }

            try {
                const state = window.OceanDynamics.getCurrentState();
                
                if (state && state.id) {
                    addResult('featuresResults', `‚úì Estado inicial: ${state.name}`, 'pass');
                    
                    // Test update
                    window.OceanDynamics.updateState({ sentiment: 0.8, depth: 0.5 });
                    const newState = window.OceanDynamics.getCurrentState();
                    addResult('featuresResults', `‚úì Estado actualizado: ${newState.name}`, 'pass');
                } else {
                    addResult('featuresResults', '‚úó Estado no v√°lido', 'fail');
                }
            } catch (error) {
                addResult('featuresResults', `‚úó Error: ${error.message}`, 'fail');
            }
        }

        async function testOceanColors() {
            clearResults('featuresResults');
            addResult('featuresResults', 'üé® Probando colores del oc√©ano...', 'info');
            
            if (!window.OceanDynamics) {
                addResult('featuresResults', '‚úó OceanDynamics no encontrado', 'fail');
                return;
            }

            try {
                const states = ['neutral', 'confused', 'anxious', 'processing', 'clarity', 'resolved'];
                const ocean = document.querySelector('.ocean-background');
                
                if (!ocean) {
                    addResult('featuresResults', '‚ö†Ô∏è No hay elemento .ocean-background en esta p√°gina', 'info');
                    addResult('featuresResults', 'üí° Abre ocean_colors_test.html para ver los colores', 'info');
                    return;
                }
                
                let passed = 0;
                for (const stateId of states) {
                    const state = window.OceanDynamics.states[stateId];
                    if (state && state.colors && state.colors.dark && state.colors.light) {
                        addResult('featuresResults', `‚úì ${state.name}: ${state.colors.dark.length} colores`, 'pass');
                        passed++;
                    } else {
                        addResult('featuresResults', `‚úó ${stateId}: Sin colores definidos`, 'fail');
                    }
                }
                
                addResult('featuresResults', `üìä ${passed}/${states.length} estados con colores`, passed === states.length ? 'pass' : 'fail');
            } catch (error) {
                addResult('featuresResults', `‚úó Error: ${error.message}`, 'fail');
            }
        }

        async function testModal() {
            clearResults('featuresResults');
            addResult('featuresResults', 'üìã Probando sistema de modal...', 'info');
            
            if (!window.showCustomConfirm) {
                addResult('featuresResults', '‚úó showCustomConfirm no encontrado', 'fail');
                return;
            }

            try {
                // Show modal (don't wait for user interaction)
                window.showCustomConfirm(
                    'Test Modal',
                    'Este es un modal de prueba',
                    () => addResult('featuresResults', '‚úì Modal confirmado', 'pass'),
                    () => addResult('featuresResults', '‚úì Modal cancelado', 'pass')
                );
                
                // Check if modal exists
                setTimeout(() => {
                    const modal = document.querySelector('.modal-overlay, #customModal');
                    if (modal) {
                        addResult('featuresResults', '‚úì Modal renderizado correctamente', 'pass');
                        // Auto-close for testing
                        const cancelBtn = document.getElementById('modalCancelBtn');
                        if (cancelBtn) cancelBtn.click();
                    } else {
                        addResult('featuresResults', '‚úó Modal no se renderiz√≥', 'fail');
                    }
                }, 100);
            } catch (error) {
                addResult('featuresResults', `‚úó Error: ${error.message}`, 'fail');
            }
        }

        // Responsive Test
        async function testResponsive() {
            clearResults('responsiveResults');
            addResult('responsiveResults', 'üì± Probando responsive...', 'info');
            
            const breakpoints = [
                { name: 'Desktop', width: 1920 },
                { name: 'Laptop', width: 1366 },
                { name: 'Tablet', width: 768 },
                { name: 'Mobile', width: 375 }
            ];

            const originalWidth = window.innerWidth;
            
            for (const bp of breakpoints) {
                // Note: Can't actually resize window in test, but we can check CSS
                addResult('responsiveResults', `üìè ${bp.name} (${bp.width}px)`, 'info');
            }
            
            addResult('responsiveResults', `‚úì Ancho actual: ${window.innerWidth}px`, 'pass');
            addResult('responsiveResults', 'üí° Redimensiona la ventana para probar breakpoints', 'info');
        }

        // Run All Tests
        async function runAllTests() {
            clearResults('allResults');
            addResult('allResults', 'üöÄ Ejecutando todos los tests...', 'info');
            addResult('allResults', '‚è≥ Esto tomar√° unos segundos...', 'info');
            
            const startTime = Date.now();
            
            await testI18n();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAllTranslations();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testThemeSwitch();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testWaveSelection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSuggestions();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAchievements();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOceanDynamics();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOceanColors();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testModal();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testResponsive();
            
            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);
            
            addResult('allResults', `‚úÖ Todos los tests completados en ${duration}s`, 'pass');
            addResult('allResults', 'üìä Revisa cada secci√≥n para ver resultados detallados', 'info');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Test suite cargado');
            console.log('üëâ Usa los botones del panel para ejecutar tests');
            
            // Check what's loaded
            console.log('‚úì Scripts cargados:');
            console.log('  - translations:', typeof window.translations !== 'undefined');
            console.log('  - i18n:', typeof window.i18n !== 'undefined');
            console.log('  - showCustomConfirm:', typeof window.showCustomConfirm !== 'undefined');
            console.log('  - SuggestionSystem:', typeof window.SuggestionSystem !== 'undefined');
            console.log('  - OceanDynamics:', typeof window.OceanDynamics !== 'undefined');
            console.log('  - AchievementSystem:', typeof window.AchievementSystem !== 'undefined');
        });
        
        // Error handler
        window.addEventListener('error', (e) => {
            console.error('‚ùå Error cargando script:', e.filename, e.message);
        });
    </script>
</body>
</html>
